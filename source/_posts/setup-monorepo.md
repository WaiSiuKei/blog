---
title: Monorepoç ”ç©¶
date: 2019-05-30 11:17:09
tags: æŠ€æœ¯
---
# Monorepo
å…±äº«ä»£ç ç®¡ç†æœ‰å¾ˆå¤šç§å½¢å¼ï¼Œæœ‰åˆ†ä»“åº“åˆ†é¡¹ç›®çš„åšæ³•ã€Git Submodulesã€æŠŠå…¨éƒ¨ä»£ç é›†ä¸­åœ¨ä¸€ä¸ªä»£ç ä»“åº“çš„æ–¹å¼ã€‚åé¢ä¸€ç§ä»£ç ç»„ç»‡å½¢å¼ç§°ä¸ºMonorepoï¼Œå®ƒæå€¡çš„æ˜¯ï¼Œå¼€å‘å›¢é˜Ÿåº”å°†ä»£ç æ”¾åˆ°ä¸€ä¸ªrepoé‡Œï¼Œè€Œä¸æ˜¯å»ç»´æŠ¤ä¸åŒçš„repoã€‚
å‡è®¾ä¸€ç§åœºæ™¯ï¼Œä¸¤ä¸ªæ¨¡å—ä¹‹é—´çš„æ¥å£éœ€è¦ä¿®æ”¹ï¼Œå¦‚æœé‡‡ç”¨å¤šä»“åº“çš„å½¢å¼ï¼Œéœ€è¦ç»è¿‡çš„æ­¥éª¤æ˜¯ï¼šä¿®æ”¹è¢«ä¾èµ–çš„ä»“åº“ã€å‘å¸ƒæ›´æ–°ã€ä¸‹æ¸¸ä»“åº“æ›´æ–°ä¾èµ–è¿›è¡Œå¼€å‘ã€æ›´æ–°å‘å¸ƒç­‰ï¼›å¦‚æœé‡‡ç”¨monorepoï¼Œå¯ä»¥åšåˆ°å¼€å‘æ—¶åŒæ—¶ä¿®æ”¹ï¼Œç„¶ååŒæ—¶å‘å¸ƒæ–°ç‰ˆæœ¬ã€‚
å½“ç„¶ä¼˜åŠ¿çš„åœ°æ–¹ä¹Ÿæœ‰å¾ˆå¤šï¼Œå¾ˆå¤šæ–‡ç« ä¹Ÿæœ‰ä»‹ç»ï¼Œæ¯”å¦‚[è¿™ä¸ª](https://pspdfkit.com/blog/2019/benefits-of-a-monorepo/)ã€‚
# Lerna
Monorepoå¾ˆæ—©å°±æœ‰é¡¹ç›®è¿›è¡Œå®è·µï¼Œæ¯”å¦‚React, ç„¶åLernaçš„æµè¡Œï¼Œå‡ºç°äº†æ›´å¤šMonorepoã€‚
Lernaçš„è‡ªæˆ‘ä»‹ç»æ˜¯
> A tool for managing JavaScript projects with multiple packages.

å®ƒæŠŠå„ä¸ªæ¨¡å—ç§°ä¸ºpackageï¼Œå¹¶ä¸”å®šä¹‰äº†è¿™ä¹ˆä»£ç ç»„ç»‡ç»“æ„ï¼Œ
```
lerna-repo/
  package.json
  packages/
    package-1/
      package.json
    package-2/
      package.json
```
ğŸ‘†çš„packageéƒ½æ”¾åˆ°ä¸€ä¸ªå«åšpackagesçš„ç›®å½•é‡Œï¼Œå½“ç„¶è¿™ä¸ªç›®å½•å¯ä»¥æ˜¯å…¶ä»–åå­—ï¼Œä¹Ÿå¯ä»¥æœ‰å¤šä¸ªè¿™ç±»ç›®å½•ã€‚ç„¶åLernaå¯ä»¥æä¾›å„ç§æ–¹ä¾¿çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ğŸ‘‡å‡ ä¸ªï¼š
### bootstrapå‘½ä»¤
å»ºç«‹è¿™ä¸ªçš„ç›®å½•ç»“æ„åï¼Œé¦–å…ˆè¿è¡Œ`lerna bootstrap`å‘½ä»¤ï¼Œå®‰è£…å„ä¸ªpkgçš„ä¾èµ–ã€‚ä¸åœ¨å„ä¸ªpkgç›®å½•æ‰‹åŠ¨å®‰è£…ä¸åŒï¼Œ`bootstrap`å‘½ä»¤ä¼šæŠŠå…¬å…±å‘½ä»¤linkåˆ°åŒä¸€å¤„ï¼Œè¾¾åˆ°èŠ‚çœèµ„æºåˆ°ç›®æ ‡ã€‚
### buildå‘½ä»¤
`lerna bootstrap`å‘½ä»¤ä¼šå¯¹å„ä¸ªpkgè¿›è¡Œæ„å»ºã€‚å¦‚æœå„ä¸ªpkgä¹‹å‰å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»ä¼šå½¢æˆæœ‰å‘å›¾ï¼ŒLernaä¼šè¿›è¡Œæ‹“æ‰‘æ’åºï¼Œå¾—åˆ°ä¸€ä¸ªæ‰“åŒ…é¡ºåºç»“æœï¼ŒæŒ‰è¿™ä¸ªé¡ºåºé€ä¸€æ„å»ºã€‚
### versionå‘½ä»¤
é¡¹ç›®é‡Œé¢çš„pkgå¯ä»¥é‡‡ç”¨ç‹¬ç«‹ç‰ˆæœ¬å·å’Œç»Ÿä¸€ç‰ˆæœ¬å·ä¸¤ç§ç‰ˆæœ¬å·ç®¡ç†å½¢å¼ã€‚é‡‡ç”¨ç‹¬ç«‹ç‰ˆæœ¬å·æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨å¯¹æ¯ä¸ªåŒ…çš„ç‰ˆæœ¬å·è¿›è¡Œå‡çº§ç®¡ç†ï¼›é‡‡ç”¨ç»Ÿä¸€ç‰ˆæœ¬å·æ—¶ï¼Œ`lerna version`å‘½ä»¤å¯ä»¥å¸®åŠ©æ‰§è¡Œç‰ˆæœ¬å·æ›´æ–°å’Œreleaseã€‚é¡¹ç›®å¤§äº†è¿˜æ˜¯é‡‡ç”¨ç»Ÿä¸€ç‰ˆæœ¬æ–¹ä¾¿ï¼Œé¿å…å„ä¸ªç‰ˆæœ¬é—´æ½œåœ¨çš„ä¸å…¼å®¹ã€‚
# Typescript Path mapping
åˆšå¼€å§‹å°è¯•Monorepoæ—¶ï¼Œæˆ‘å‚è€ƒäº†ä¸€äº›ç”¨äº†Lernaåœ°é¡¹ç›®, å»ºç«‹ç±»ä¼¼åœ°ç›®å½•ç»“æ„ï¼Œç„¶åæ‰‹åŠ¨åˆ°å„ä¸ªç›®å½•è¿è¡Œ`npm install`ï¼Œç„¶åç”¨Typescriptå¼€å‘ã€‚æˆ‘çš„å„ä¸ªæ¨¡å—ä¼šæœ‰ç›¸äº’ä¾èµ–ï¼ŒæŸ¥äº†ä¸€ä¸‹Typescriptæ–‡æ¡£ï¼Œæ‰¾åˆ°äº†æ¨¡å—å¯»æ‰¾ç›¸å…³çš„[æ–‡ç« ](https://www.typescriptlang.org/docs/handbook/module-resolution.html)ã€‚å®ƒæåˆ°äº†Path mappingï¼Œå¯ä»¥æŠŠæŒ‡å®šç¬¬ä¸‰æ–¹ä¾èµ–å¯»æ‰¾çš„ç›®å½•ã€‚
# NPM local pathså’ŒNPM link
NPMçš„[local paths](https://docs.npmjs.com/files/package.json#local-paths)åŠŸèƒ½æä¾›ä¸€ç§æŒ‡å®šæœ¬åœ°ç›®å½•ä½œä¸ºä¾èµ–çš„åŠŸèƒ½ï¼Œé€‚åˆæœ¬åœ°å¼€å‘ï¼Œå¦‚æœå‘å¸ƒä¸ºNPMåŒ…ä¼šæœ‰é—®é¢˜ï¼Œç”¨æˆ·ç”µè„‘ä¸Šä¸ä¸€å®šæœ‰ä¸€æ ·çš„ç›®å½•ç»“æ„ã€‚ç±»ä¼¼çš„åŠŸèƒ½æ˜¯`npm link`, è¿™ä¸ªä¹Ÿæ˜¯**åª**é€‚åˆæœ¬åœ°å¼€å‘ï¼Œè€Œä¸”åœ¨monorepoä¸‹è¦ä¸€ä¸ªä¸€ä¸ªæ‰‹åŠ¨æ‰§è¡Œã€‚
# Webpack alias
Webpacké…ç½®é€‰é¡¹é‡Œçš„resolveæœ‰ä¸ªaliaså±æ€§ï¼Œå¯ä»¥æŒ‡å®šè·¯å¾„çš„åˆ«åï¼ŒMonorepoé‡Œå¦‚æœæœ‰webpackæ„å»ºçš„å†…å®¹æ—¶ï¼Œè¿˜éœ€è¦æ‰‹åŠ¨æŒ‡å®šè¿™ä¸€é¡¹ã€‚
# Yarn workspace
æˆ‘åœ¨å¼€å‘è‡ªå·±çš„monorepoæ—¶ï¼ŒTypescript Path mappingåŸºæœ¬å¤Ÿç”¨ï¼Œä½†æ˜¯å› ä¸ºå®šä¹‰æ–‡ä»¶ç”Ÿæˆå·¥å…·[dts-bundle-generator](https://github.com/timocov/dts-bundle-generator)åœ¨å¤„ç†ä¾èµ–é¡¹æ—¶ï¼Œå¦‚æœä¸æ˜¯å®šä¹‰åœ¨package.jsonçš„è¯ï¼Œå®ƒä¼šæŠŠå…¶ä»–æ¨¡å—çš„å†…å®¹å†…è”ã€‚
è§£å†³æ–¹æ¡ˆæ˜¯Yarn workspaceï¼Œå®ƒæä¾›äº†æŠŠå„ä¸ªæ¨¡å—linkåˆ°ä¸Šä¸€çº§ä¾èµ–ç›®å½•çš„åŠŸèƒ½ã€‚æŒ‰ç…§Node.jsæ¨¡å—å¯»æ‰¾è§„åˆ™ï¼Œæœ¬çº§ç›®å½•ä¸‹çš„node_modulesä¸å­˜åœ¨çš„è¯ï¼ŒNode.jsä¼šæŸ¥æ‰¾ä¸Šä¸€çº§ç›®å½•é‡Œçš„node_modulesç›®å½•ï¼Œä¸€è·¯å¾€ä¸Šç›´è‡³ç”¨æˆ·æ–‡ä»¶å¤¹ã€‚è¿™ä¸ªsymbol linkå¯ä»¥åœ¨å¼€å‘æ—¶ï¼Œè¢«ä¾èµ–æ¨¡å—æ›´æ–°ä»£ç åï¼Œä¾èµ–çš„æ¨¡å—å¯ä»¥æ— æ„Ÿåœ°ç»§ç»­å¼€å‘ï¼Œä¸ç”¨å…³æ³¨ä¾èµ–æ›´æ–°é—®é¢˜ï¼›Yarn workspaceå¯ä»¥è‡ªåŠ¨workspaceä¸‹çš„å¤šä¸ªç›®å½•ï¼Œæ¯”èµ·æ‰‹åŠ¨ä¸€ä¸ªä¸€ä¸ªè¿è¡Œ`npm link`ä¼šæ–¹ä¾¿å¾ˆå¤šï¼›å„ä¸ªæ¨¡å—çš„package.jsoné€‚åˆå‘å¸ƒåˆ°NPMï¼Œä¸ä¼šæœ‰NPM local pathsçš„é—®é¢˜ã€‚Lernaå’ŒYarn workspaceå¯ä»¥å åŠ ä½¿ç”¨ã€‚
# åè®°
åœ¨æ­å»ºè‡ªå·±çš„monorepoæ—¶ï¼Œè¯•è¿‡ğŸ‘†å…¨éƒ½æ–¹æ¡ˆï¼Œæœ€åç¡®å®šçš„æ˜¯ï¼šç›®å½•æŒ‰Lernaå’ŒYarn workspaceé…ç½®ã€ç„¶åè¿è¡Œ`lerna bootstrap`å®‰è£…ä¾èµ–ã€‚
æœŸé—´è¿˜æœ‰äº›å¼€å‘æ—¶é‡åˆ°çš„é—®é¢˜ï¼š
## WebStormçš„å‘
WebStormé‡Œé¢ä½¿ç”¨çš„Typescript compilerä¼šæœ‰äº›é—®é¢˜ï¼Œæ¯”å¦‚åœ¨æŸä¸ªæ¨¡å—é‡Œé‡åˆ°çš„é”™è¯¯:
> Error:TS6053: File '/Users/wei/fin/packages/linkedlist/node_modules/typescript/lib/lib.dom.d.ts' not found.

è§£å†³è¿™ä¸ªæ˜¯ï¼Œåœ¨workspace rootå®‰è£…Typescriptï¼Œå³ä½¿Yarnä¸æå€¡è¿™æ ·åšã€‚
> error Running this command will add the dependency to the workspace root rather than the workspace itself, which might not be what you want - if you really meant it, make it explicit by running this command again with the -W flag (or --ignore-workspace-root-check).
info Visit https://yarnpkg.com/en/docs/cli/add for documentation about this command.

## dts-bundle-generatorçš„å‘
dts-bundle-generatorå³ä½¿æŒ‰ä¸Šé¢çš„ Lerna + Yarn workspace æ­å»ºåï¼Œè¿˜ä¼šå‡ºç°å£°æ˜å†…è”çš„æƒ…å†µï¼Œè¯•äº†å¥½ä¹…ï¼ŒåŠ äº†Path mappingå€’æ˜¯å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†æ˜¯ä¸å¤ªå¥½ï¼Œå› ä¸ºåœ¨ä½¿ç”¨Path mappingæ—¶ï¼ŒWebStromçš„è‡ªåŠ¨importå¤ªå‚»ï¼Œå¦‚æœé‡Œé¢æœ‰è‡ªèº«ç›®å½•ï¼ŒåŒä¸€æ¨¡å—ä¸‹ä¸ªä¸¤ä¸ªæ–‡ä»¶é—´importï¼Œå±…ç„¶ä¸æ˜¯ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè€Œæ˜¯`pkg-name/src/path/to/file`ï¼Œè¿™æ ·çš„å½¢å¼ã€‚
æ›´æ–°ä¸€ä¸‹ï¼Œç»™ä½œè€…æäº†[Issue](https://github.com/timocov/dts-bundle-generator/issues/91)åï¼Œä½œè€…ç»™å‡ºä¸€ä¸ªç”¨æ¥å¤„ç†è¿™ç§æƒ…å†µçš„é…ç½®é¡¹ï¼Œæ‰€ä»¥Path mappingå¯ä»¥å»æ‰ã€‚
